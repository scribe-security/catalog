---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: scribe-security
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/categories: Security
    tekton.dev/tags: CLI, valint
    tekton.dev/displayName: valint
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This task can be used to generate sbom and verify the sbom
  params:
    - name: args
      description: The repository URL to inspect
      type: string
    - name: scribe-secret
      description: Scribe secret name
      type: string
    - name: image-version-sha
      description: sha of the valint image to be used
      default: sha256:961e3e0292338e11f6c5c48645d684aaf05aa76c8e3e6fa2a786628b60c2a11d
  steps:
    - name: bom
      image: scribesecuriy.jfrog.io/scribe-docker-public-local/valint@$(params.image-version-sha)
      script: |
        #!/bin/sh
        ARGS=""
        if [ "${PRODUCT_KEY}" != "" ]; then
          ARGS="${ARGS} --product-key ${PRODUCT_KEY}"
        fi
        if [ "${SCRIBE_CLIENT_ID}" != "" ]; then
          ARGS="${ARGS} -U ${SCRIBE_CLIENT_ID}"
        fi
        if [ "${SCRIBE_CLIENT_SECRET}" != "" ]; then
          ARGS="${ARGS} -P ${SCRIBE_CLIENT_SECRET}"
        fi
        echo $VALINT_ARGS $ARGS
        valint $VALINT_ARGS $ARGS
      env:
        - name: PRODUCT_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.scribe-secret)
              key: product_key
        - name: SCRIBE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: $(params.scribe-secret)
              key: client_id
        - name: SCRIBE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: $(params.scribe-secret)
              key: client_secret
        - name: VALINT_ARGS
          value: $(params.args)
